#!/bin/bash

# Script para diagnosticar el error de autorizaciÃ³n de Strava

echo "ğŸ” Diagnosticando Error de AutorizaciÃ³n de Strava"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

echo "1ï¸âƒ£ Verificando redirect_uri usado en la app..."
echo ""
echo "   Redirect URI en la app:"
echo "   https://uprohtkbghujvjwjnqyv.supabase.co/functions/v1/strava-auth"
echo ""

echo "2ï¸âƒ£ Verificando configuraciÃ³n necesaria en Strava..."
echo ""
echo "   âš ï¸  IMPORTANTE: El redirect_uri DEBE estar configurado en Strava"
echo ""
echo "   Ve a: https://www.strava.com/settings/api"
echo "   Haz clic en tu aplicaciÃ³n 'BeRun'"
echo "   Busca 'Authorization Callback Domain' o 'Redirect URI'"
echo "   Debe incluir:"
echo "   â€¢ https://uprohtkbghujvjwjnqyv.supabase.co"
echo "   O especÃ­ficamente:"
echo "   â€¢ https://uprohtkbghujvjwjnqyv.supabase.co/functions/v1/strava-auth"
echo ""

echo "3ï¸âƒ£ Verificando variables de entorno en Supabase..."
echo ""
echo "   Ve a: https://supabase.com/dashboard/project/uprohtkbghujvjwjnqyv/settings/functions"
echo "   Verifica que existan estas variables:"
echo ""
echo "   âœ… STRAVA_CLIENT_ID = 186314"
echo "   âœ… STRAVA_CLIENT_SECRET = fa541a582f6dde856651e09cb546598865b000b15"
echo "   âœ… STRAVA_WEBHOOK_VERIFY_TOKEN = berun_webhook_verify_2024"
echo ""

echo "4ï¸âƒ£ Verificando logs de la Edge Function..."
echo ""
echo "   Ve a: https://supabase.com/dashboard/project/uprohtkbghujvjwjnqyv/functions"
echo "   Haz clic en 'strava-auth'"
echo "   Ve a la pestaÃ±a 'Logs'"
echo "   Busca errores relacionados con:"
echo "   â€¢ Missing environment variables"
echo "   â€¢ STRAVA_CLIENT_SECRET"
echo "   â€¢ Token exchange failed"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ”§ POSIBLES CAUSAS DEL ERROR:"
echo ""
echo "1. âŒ Redirect URI no configurado en Strava"
echo "   â†’ SoluciÃ³n: Configurar en Strava Dashboard"
echo ""
echo "2. âŒ Variables de entorno no configuradas"
echo "   â†’ SoluciÃ³n: Configurar en Supabase Dashboard"
echo ""
echo "3. âŒ Client Secret incorrecto o no configurado"
echo "   â†’ SoluciÃ³n: Verificar en Supabase y Strava"
echo ""
echo "4. âŒ CÃ³digo de autorizaciÃ³n ya usado o expirado"
echo "   â†’ SoluciÃ³n: Intentar conectar de nuevo"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "âœ… PASOS PARA SOLUCIONAR:"
echo ""
echo "PASO 1: Configurar Redirect URI en Strava"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "1. Ve a: https://www.strava.com/settings/api"
echo "2. Haz clic en 'BeRun'"
echo "3. Busca 'Authorization Callback Domain'"
echo "4. AÃ±ade: uprohtkbghujvjwjnqyv.supabase.co"
echo "5. O el URI completo si lo requiere"
echo "6. Guarda los cambios"
echo ""
echo "PASO 2: Verificar Variables de Entorno"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "1. Ve a: https://supabase.com/dashboard/project/uprohtkbghujvjwjnqyv/settings/functions"
echo "2. Verifica que existan las 3 variables mencionadas arriba"
echo "3. Si no existen, crÃ©alas"
echo ""
echo "PASO 3: Revisar Logs"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "1. Ve a los logs de strava-auth"
echo "2. Intenta conectar de nuevo"
echo "3. Revisa los mensajes de error especÃ­ficos"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

